name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Download playit.gg client
      run: Invoke-WebRequest "https://playit.gg/downloads/playit-windows.exe" -OutFile "playit.exe"

    - name: Enable Remote Desktop (RDP)
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Set Password for TranAnhKhoa
      run: |
        Set-LocalUser -Name "TranAnhKhoa" -Password (ConvertTo-SecureString -AsPlainText "AnhKhoa123@" -Force)

    - name: Login to playit.gg
      run: |
        echo $Env:PLAYIT_SECRET | Out-File -Encoding ASCII secret.txt
        .\playit.exe login < secret.txt
      env:
        PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}

    - name: Start Tunnel (TCP 3389)
      run: .\playit.exe serve
